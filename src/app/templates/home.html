<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limbus Company Progress</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { background-color: white; padding: 2em; margin: 2em auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 800px; }
        h1, h2 { color: #343a40; }
        hr { border: 0; height: 1px; background-color: #e9ecef; margin: 2em 0; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: .5rem; font-weight: 500; }
        select, input[type="number"] { width: 100%; padding: .5rem; margin-top: .25rem; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        .toggle-switch { display: flex; border: 1px solid #ced4da; border-radius: 4px; overflow: hidden; }
        .toggle-switch input[type="radio"] { display: none; }
        .toggle-switch label { flex: 1; text-align: center; padding: .5rem; cursor: pointer; background-color: #f8f9fa; transition: background-color 0.2s; }
        .toggle-switch input[type="radio"]:checked + label { background-color: #007bff; color: white; }
        .button { display: inline-block; padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-top: 1em; }
        .button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Limbus Company Progress Tracker</h1>
        <hr>

        <h2>Manually Update E.G.O. Level</h2>
        <form id="egoUpdateForm" action="{{ url_for('update_ego_level') }}" method="post">
            <div class="form-group">
                <label for="sinner">Sinner:</label>
                <select id="sinner" name="sinner" required>
                    <option value="">-- Select a Sinner --</option>
                    {% for sinner in all_sinners_data.sinners %}
                        <option value="{{ sinner.name }}">{{ sinner.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="ego">E.G.O:</label>
                <select id="ego" name="E.G.O." required>
                    <option value="">-- Select an E.G.O. --</option>
                </select>
            </div>
            <div class="form-group">
                <label>New Uptie Level:</label>
                <div class="toggle-switch">
                    <input type="radio" id="level0" name="new_level" value="0" required><label for="level0">Unobtained</label>
                    <input type="radio" id="level1" name="new_level" value="1"><label for="level1">1</label>
                    <input type="radio" id="level2" name="new_level" value="2"><label for="level2">2</label>
                    <input type="radio" id="level3" name="new_level" value="3"><label for="level3">3</label>
                    <input type="radio" id="level4" name="new_level" value="4"><label for="level4">4</label>
                </div>
            </div>
        </form>

        <hr>

        <a href="{{ url_for('visualizer') }}" class="button" style="display: block; text-align: center; margin-bottom: 1rem;">View Progress Visualization</a>

    </div>

    <script>
        // Data for JS interop
        const sinnerEgoMap = {
            {% for sinner in all_sinners_data.sinners %}
                "{{ sinner.name }}": [{% for ego in sinner.egos %}{"id": "{{ ego.id }}", "name": "{{ ego.name }}"}{% if not loop.last %}, {% endif %}{% endfor %}],
            {% endfor %}
        };

        const egoProgressData = {
            {% for ego in ego_display_data %}
                "{{ ego.id }}": { "current_uptie": {{ ego.current_uptie }} }{% if not loop.last %}, {% endif %}
            {% endfor %}
        };

        const sinnerSelect = document.getElementById('sinner');
        const egoSelect = document.getElementById('ego');
        const levelRadios = document.querySelectorAll('input[name="new_level"]');
        const egoUpdateForm = document.getElementById('egoUpdateForm');

        function setLevelRadio(level) {
            levelRadios.forEach(radio => {
                radio.checked = parseInt(radio.value) === level;
            });
        }

        function updateEgoDropdown(selectedSinnerId, selectedEgoId) {
            const egos = sinnerEgoMap[selectedSinnerId] || [];
            egoSelect.innerHTML = '<option value="">-- Select an E.G.O. --</option>';
            egos.forEach(function(ego) {
                const option = document.createElement('option');
                option.value = ego.id;
                option.textContent = ego.name;
                egoSelect.appendChild(option);
            });

            if (selectedEgoId) {
                egoSelect.value = selectedEgoId;
                if (egoSelect.value === selectedEgoId) {
                    egoSelect.dispatchEvent(new Event('change'));
                }
            } else {
                setLevelRadio(0);
            }
        }

        sinnerSelect.addEventListener('change', function() {
            localStorage.setItem('selectedSinner', this.value);
            updateEgoDropdown(this.value, localStorage.getItem('selectedEgo'));
        });

        egoSelect.addEventListener('change', function() {
            localStorage.setItem('selectedEgo', this.value);
            if (this.value && egoProgressData[this.value]) {
                setLevelRadio(egoProgressData[this.value].current_uptie);
            } else {
                setLevelRadio(0);
            }
        });

        levelRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const egoId = egoSelect.value;
                const newLevel = this.value;

                if (egoId) {
                    const formData = new FormData();
                    formData.append('E.G.O.', egoId);
                    formData.append('new_level', newLevel);

                    fetch(egoUpdateForm.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            if (egoProgressData[egoId]) {
                                egoProgressData[egoId].current_uptie = parseInt(newLevel);
                            }
                            console.log('Update successful');
                        } else {
                            console.error('Update failed');
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const storedSinner = localStorage.getItem('selectedSinner');
            const storedEgo = localStorage.getItem('selectedEgo');
            if (storedSinner) {
                sinnerSelect.value = storedSinner;
                updateEgoDropdown(storedSinner, storedEgo);
            }
        });
    </script>
</body>
</html>
